<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Courier New:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Prometheus,Alertmanager," />





  <link rel="alternate" href="/atom.xml" title="天青色等烟雨" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon/favicon.ico?v=5.0.1" />






<meta name="description" content="真正的坚强，是属于那些夜晚在被窝里哭泣，而白天却若无其事的人。未曾深夜痛哭过的人，不足以谈论人生。

基本概述我们先从应用的角度来看详细的介绍一下alertmanager以下简称am，以下是官方文档介绍。

The Alertmanager handles alerts sent by client applications such as the Prometheus server. It ta">
<meta property="og:type" content="article">
<meta property="og:title" content="Alertmanager 使用原理和源码分析">
<meta property="og:url" content="https://magiceses.github.io/2020/03/31/prometheus-alertmanager-使用原理和源码分析/index.html">
<meta property="og:site_name" content="天青色等烟雨">
<meta property="og:description" content="真正的坚强，是属于那些夜晚在被窝里哭泣，而白天却若无其事的人。未曾深夜痛哭过的人，不足以谈论人生。

基本概述我们先从应用的角度来看详细的介绍一下alertmanager以下简称am，以下是官方文档介绍。

The Alertmanager handles alerts sent by client applications such as the Prometheus server. It ta">
<meta property="og:image" content="https://magiceses.github.io/images/prometheus-alertmanager-8.png">
<meta property="og:image" content="https://magiceses.github.io/images/prometheus-alertmanager-9.png">
<meta property="og:image" content="https://magiceses.github.io/images/prometheus-alertmanager-10.jpg">
<meta property="og:updated_time" content="2021-10-02T07:58:41.115Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Alertmanager 使用原理和源码分析">
<meta name="twitter:description" content="真正的坚强，是属于那些夜晚在被窝里哭泣，而白天却若无其事的人。未曾深夜痛哭过的人，不足以谈论人生。

基本概述我们先从应用的角度来看详细的介绍一下alertmanager以下简称am，以下是官方文档介绍。

The Alertmanager handles alerts sent by client applications such as the Prometheus server. It ta">
<meta name="twitter:image" content="https://magiceses.github.io/images/prometheus-alertmanager-8.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="https://magiceses.github.io/2020/03/31/prometheus-alertmanager-使用原理和源码分析/"/>


<!-- 网页加载条 -->
<script src="/js/src/pace.min.js"></script>
  <title> Alertmanager 使用原理和源码分析 | 天青色等烟雨 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">天青色等烟雨</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">而我在等你</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-commenting"></i> <br />
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
      
      
        <li class="menu-item"> <a title="把这个链接拖到你的工具栏中,任何网页都可以High" href='javascript:(
/*
 * Copyright (C) 2016 Never_yu (Neveryu.github.io) <React.dong.yu@gmail.com>
 * Sina Weibo (http://weibo.com/Neveryu)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function go() {

var songs = [
  "http://dl.stream.qqmusic.qq.com/C400001Qu4I30eVFYb.m4a?vkey=2127178E4405E7B8B268F20F05232485735CCF4FF8C1432F0360D2626D0B6C9564B5627C7AB481BBC685FEDB0946A50E97C66F0D1B008226&guid=7175649092&uin=0&fromtag=66",
  "",
  "",
  ""
];

function c() {
  var e = document.createElement("link");
  e.setAttribute("type", "text/css");
  e.setAttribute("rel", "stylesheet");
  e.setAttribute("href", f);
  e.setAttribute("class", l);
  document.body.appendChild(e)
}

function h() {
  var e = document.getElementsByClassName(l);
  for (var t = 0; t < e.length; t++) {
    document.body.removeChild(e[t])
  }
}

function p() {
  var e = document.createElement("div");
  e.setAttribute("class", a);
  document.body.appendChild(e);
  setTimeout(function() {
    document.body.removeChild(e)
  }, 100)
}

function d(e) {
  return {
    height : e.offsetHeight,
    width : e.offsetWidth
  }
}

function v(i) {
  var s = d(i);
  return s.height > e && s.height < n && s.width > t && s.width < r
}

function m(e) {
  var t = e;
  var n = 0;
  while (!!t) {
    n += t.offsetTop;
    t = t.offsetParent
  }
  return n
}

function g() {
  var e = document.documentElement;
  if (!!window.innerWidth) {
    return window.innerHeight
  } else if (e && !isNaN(e.clientHeight)) {
    return e.clientHeight
  }
  return 0
}

function y() {
  if (window.pageYOffset) {
    return window.pageYOffset
  }
  return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
}

function E(e) {
  var t = m(e);
  return t >= w && t <= b + w
}

function S() {
  var e = document.getElementById("audio_element_id");
  if(e != null){
    var index = parseInt(e.getAttribute("curSongIndex"));
    if(index > songs.length - 2) {
      index = 0;
    } else {
      index++;
    }
    e.setAttribute("curSongIndex", index);
    N();
  }

  e.src = i;
  e.play()
}

function x(e) {
  e.className += " " + s + " " + o
}

function T(e) {
  e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
}

function N() {
  var e = document.getElementsByClassName(s);
  var t = new RegExp("\\b" + s + "\\b");
  for (var n = 0; n < e.length; ) {
    e[n].className = e[n].className.replace(t, "")
  }
}

function initAudioEle() {
  var e = document.getElementById("audio_element_id");
  if(e === null){
    e = document.createElement("audio");
    e.setAttribute("class", l);
    e.setAttribute("curSongIndex", 0);
    e.id = "audio_element_id";
    e.loop = false;
    e.bgcolor = 0;
    e.addEventListener("canplay", function() {
      setTimeout(function() {
        x(k)
      }, 500);
      setTimeout(function() {
        N();
        p();
        for (var e = 0; e < O.length; e++) {
          T(O[e])
        }
      }, 15500)
    }, true);
    e.addEventListener("ended", function() {
      N();
      h();
      go();
    }, true);
    e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
    document.body.appendChild(e);
  }
}

initAudioEle();
var e = 30;
var t = 30;
var n = 350;
var r = 350;

var curSongIndex = parseInt(document.getElementById("audio_element_id").getAttribute("curSongIndex"));
var i = songs[curSongIndex];

var s = "mw-harlem_shake_me";
var o = "im_first";
var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
var a = "mw-strobe_light";

/* harlem-shake-style.css，替换成你的位置，也可以直接使用：//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css */
var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";

var l = "mw_added_css";
var b = g();
var w = y();
var C = document.getElementsByTagName("*");
var k = null;
for (var L = 0; L < C.length; L++) {
  var A = C[L];
  if (v(A)) {
    if (E(A)) {
      k = A;
      break
    }
  }
}
if (A === null) {
  console.warn("Could not find a node of the right size. Please try a different page.");
  return
}
c();
S();
var O = [];
for (var L = 0; L < C.length; L++) {
  var A = C[L];
  if (v(A)) {
    O.push(A)
  }
}
})()'><i class="menu-item-icon fa fa-music fa-fw"></i> High一下</a></li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search fa-lg"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Alertmanager 使用原理和源码分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-03-31T07:25:24+08:00" content="2020-03-31">
              2020-03-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Prometheus/" itemprop="url" rel="index">
                    <span itemprop="name">Prometheus</span>
                  </a>
                </span>

                
                

              
            </span>
          

          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv">热度
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>℃
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p id="div-border-top-green">真正的坚强，是属于那些夜晚在被窝里哭泣，而白天却若无其事的人。未曾深夜痛哭过的人，不足以谈论人生。<br></p>

<h2 id="基本概述"><a href="#基本概述" class="headerlink" title="基本概述"></a>基本概述</h2><p>我们先从应用的角度来看详细的介绍一下alertmanager以下简称am，以下是官方文档介绍。</p>
<blockquote>
<p>The Alertmanager handles alerts sent by client applications such as the Prometheus server. It takes care of deduplicating, grouping, and routing them to the correct receiver integrations such as email, PagerDuty, or OpsGenie. It also takes care of silencing and inhibition of alerts.</p>
</blockquote>
<p>翻译一下就是，负责处理接受client（例如prometheus）发送的告警消息，包括重复告警的发送、聚合、发给相关人员，并且支持多种方式例如email或者pagerduty这种第三方通知告警平台，同时他还提供了静音以及告警抑制的功能。</p>
<p>这些功能基本涵盖了目前各大公司的告警痛点，<strong>重复告警</strong>（告警发生了但是一直也没人处理）、<strong>告警风暴</strong>（某次版本上线导致的大量服务机器指标异常）、<strong>告警信息重复</strong>（例如机器宕机之后又收到了网络不通的告警）。</p>
<p>这里注意下，prometheus族包括am他们的实现思路都是基于label来做的，后面会从代码层面详细介绍下</p>
<p>实现一个完整的监控体系需要以下几个功能：</p>
<a id="more"></a>
<ul>
<li>数据采集（xxx_export）</li>
<li>数据抓取（prometheus）</li>
<li>数据存储（prometheus/cortex）</li>
<li>规则检测并生成告警（prometheus/cotex.ruler）</li>
<li>告警处理（alertmanager）</li>
<li>告警通知（一般根据自身业务和管理体系实现）</li>
</ul>
<p><strong>Alertmanager实现了告警处理（聚合、抑制、屏蔽、路由）</strong></p>
<p>基本流程如下：</p>
<p><strong>1.</strong> Prometheus Server监控目标主机上暴露的http接口（这里假设接口A），通过上述Promethes配置的’scrape_interval’定义的时间间隔，定期采集目标主机上监控数据。</p>
<p><strong>2.</strong> 当接口A不可用的时候，Server端会持续的尝试从接口中取数据，直到”scrape_timeout”时间后停止尝试。这时候把接口的状态变为“DOWN”。</p>
<p><strong>3</strong>. Prometheus同时根据配置的”evaluation_interval”的时间间隔，定期（默认1min）的对Alert Rule进行评估；当到达评估周期的时候，发现接口A为DOWN，即UP=0为真，激活Alert，进入“PENDING”状态，并记录当前active的时间；</p>
<p><strong>4.</strong> 当下一个alert rule的评估周期到来的时候，发现UP=0继续为真，然后判断警报Active的时间是否已经超出rule里的‘for’ 持续时间，如果未超出，则进入下一个评估周期；如果时间超出，则alert的状态变为“FIRING”；同时调用Alertmanager接口，发送相关报警数据。</p>
<p><strong>5.</strong> AlertManager收到报警数据后，会将警报信息进行分组，然后根据alertmanager配置的“group_wait”时间先进行等待。等wait时间过后再发送报警信息。</p>
<p><strong>6.</strong> 属于同一个Alert Group的警报，在等待的过程中可能进入新的alert，如果之前的报警已经成功发出，那么间隔“group_interval”的时间间隔后再重新发送报警信息。比如配置的是邮件报警，那么同属一个group的报警信息会汇总在一个邮件里进行发送。</p>
<p><strong>7.</strong> 如果Alert Group里的警报一直没发生变化并且已经成功发送，等待‘repeat_interval’时间间隔之后再重复发送相同的报警邮件；如果之前的警报没有成功发送，则相当于触发第6条条件，则需要等待group_interval时间间隔后重复发送。同时最后至于警报信息具体发给谁，满足什么样的条件下指定警报接收人，设置不同报警发送频率，这里有alertmanager的route路由规则进行配置。</p>
<p>告警发送通知流程-1：</p>
<p><img src="/images/prometheus-alertmanager-8.png" alt="https://note.youdao.com/yws/public/resource/08ef03888558443a04d7f3e39c2d975d/xmlnote/WEBRESOURCEe71833b5f301818c2524048ed5ed436d/24641"></p>
<p>告警发送通知流程-2：</p>
<p><img src="/images/prometheus-alertmanager-9.png" alt="https://note.youdao.com/yws/public/resource/08ef03888558443a04d7f3e39c2d975d/xmlnote/WEBRESOURCE643c3bb348a7477a11e20d8740e182dd/24645"></p>
<h2 id="实现架构"><a href="#实现架构" class="headerlink" title="实现架构"></a>实现架构</h2><p><img src="/images/prometheus-alertmanager-10.jpg" alt="img"></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># The smarthost and SMTP sender used for mail notifications.</span></span><br><span class="line"><span class="attr">  smtp_smarthost:</span> <span class="string">'smtp.qq.com:465'</span></span><br><span class="line"><span class="attr">  smtp_from:</span> <span class="string">'447040949@qq.com'</span></span><br><span class="line"><span class="attr">  smtp_auth_username:</span> <span class="string">'447040949@qq.com'</span></span><br><span class="line"><span class="attr">  smtp_auth_password:</span> <span class="string">'nihao206206#'</span></span><br><span class="line">  <span class="comment"># The auth token for Hipchat.</span></span><br><span class="line"><span class="attr">  hipchat_auth_token:</span> <span class="string">'1234556789'</span></span><br><span class="line">  <span class="comment"># Alternative host for Hipchat.</span></span><br><span class="line"><span class="attr">  hipchat_url:</span> <span class="string">'https://hipchat.foobar.org/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The directory from which notification templates are read.</span></span><br><span class="line"><span class="attr">templates:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">'/etc/alertmanager/template/*.tmpl'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The root route on which each incoming alert enters.</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="comment"># The labels by which incoming alerts are grouped together. For example,</span></span><br><span class="line">  <span class="comment"># multiple alerts coming in for cluster=A and alertname=LatencyHigh would</span></span><br><span class="line">  <span class="comment"># be batched into a single group.</span></span><br><span class="line"><span class="attr">  group_by:</span> <span class="string">['alertname',</span> <span class="string">'cluster'</span><span class="string">,</span> <span class="string">'service'</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># When a new group of alerts is created by an incoming alert, wait at</span></span><br><span class="line">  <span class="comment"># least 'group_wait' to send the initial notification.</span></span><br><span class="line">  <span class="comment"># This way ensures that you get multiple alerts for the same group that start</span></span><br><span class="line">  <span class="comment"># firing shortly after another are batched together on the first </span></span><br><span class="line">  <span class="comment"># notification.</span></span><br><span class="line"><span class="attr">  group_wait:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># When the first notification was sent, wait 'group_interval' to send a batch</span></span><br><span class="line">  <span class="comment"># of new alerts that started firing for that group.</span></span><br><span class="line"><span class="attr">  group_interval:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If an alert has successfully been sent, wait 'repeat_interval' to</span></span><br><span class="line">  <span class="comment"># resend them.</span></span><br><span class="line"><span class="attr">  repeat_interval:</span> <span class="number">3</span><span class="string">h</span> </span><br><span class="line"></span><br><span class="line">  <span class="comment"># A default receiver</span></span><br><span class="line"><span class="attr">  receiver:</span> <span class="string">team-X-mails</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># All the above attributes are inherited by all child routes and can </span></span><br><span class="line">  <span class="comment"># overwritten on each.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The child route trees.</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line">  <span class="comment"># This routes performs a regular expression match on alert labels to</span></span><br><span class="line">  <span class="comment"># catch alerts that are related to a list of services.</span></span><br><span class="line"><span class="attr">  - match_re:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">^(foo1|foo2|baz)$</span></span><br><span class="line"><span class="attr">    receiver:</span> <span class="string">team-X-mails</span></span><br><span class="line">    <span class="comment"># The service has a sub-route for critical alerts, any alerts</span></span><br><span class="line">    <span class="comment"># that do not match, i.e. severity != critical, fall-back to the</span></span><br><span class="line">    <span class="comment"># parent node and are sent to 'team-X-mails'</span></span><br><span class="line"><span class="attr">    routes:</span></span><br><span class="line"><span class="attr">    - match:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      receiver:</span> <span class="string">team-X-pager</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">files</span></span><br><span class="line"><span class="attr">    receiver:</span> <span class="string">team-Y-mails</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    routes:</span></span><br><span class="line"><span class="attr">    - match:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      receiver:</span> <span class="string">team-Y-pager</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This route handles all alerts coming from a database service. If there's</span></span><br><span class="line">  <span class="comment"># no team to handle it, it defaults to the DB team.</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">database</span></span><br><span class="line"><span class="attr">    receiver:</span> <span class="string">team-DB-pager</span></span><br><span class="line">    <span class="comment"># Also group alerts by affected database.</span></span><br><span class="line"><span class="attr">    group_by:</span> <span class="string">[alertname,</span> <span class="string">cluster,</span> <span class="string">database]</span></span><br><span class="line"><span class="attr">    routes:</span></span><br><span class="line"><span class="attr">    - match:</span></span><br><span class="line"><span class="attr">        owner:</span> <span class="string">team-X</span></span><br><span class="line"><span class="attr">      receiver:</span> <span class="string">team-X-pager</span></span><br><span class="line"><span class="attr">    - match:</span></span><br><span class="line"><span class="attr">        owner:</span> <span class="string">team-Y</span></span><br><span class="line"><span class="attr">      receiver:</span> <span class="string">team-Y-pager</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inhibition rules allow to mute a set of alerts given that another alert is</span></span><br><span class="line"><span class="comment"># firing.</span></span><br><span class="line"><span class="comment"># We use this to mute any warning-level notifications if the same alert is </span></span><br><span class="line"><span class="comment"># already critical.</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="attr">- source_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">'critical'</span></span><br><span class="line"><span class="attr">  target_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">'warning'</span></span><br><span class="line">  <span class="comment"># Apply inhibition if the alertname is the same.</span></span><br><span class="line"><span class="attr">  equal:</span> <span class="string">['alertname',</span> <span class="string">'cluster'</span><span class="string">,</span> <span class="string">'service'</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">'team-X-mails'</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - url:</span> <span class="string">'http://u2.kugou.net:11770/sendRtxByPost'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">'team-X-pager'</span></span><br><span class="line"><span class="attr">  email_configs:</span></span><br><span class="line"><span class="attr">  - to:</span> <span class="string">'team-X+alerts-critical@example.org'</span></span><br><span class="line"><span class="attr">  pagerduty_configs:</span></span><br><span class="line"><span class="attr">  - service_key:</span> <span class="string">&lt;team-X-key&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">'team-Y-mails'</span></span><br><span class="line"><span class="attr">  email_configs:</span></span><br><span class="line"><span class="attr">  - to:</span> <span class="string">'team-Y+alerts@example.org'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">'team-Y-pager'</span></span><br><span class="line"><span class="attr">  pagerduty_configs:</span></span><br><span class="line"><span class="attr">  - service_key:</span> <span class="string">&lt;team-Y-key&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">'team-DB-pager'</span></span><br><span class="line"><span class="attr">  pagerduty_configs:</span></span><br><span class="line"><span class="attr">  - service_key:</span> <span class="string">&lt;team-DB-key&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">- name:</span> <span class="string">'team-X-hipchat'</span></span><br><span class="line"><span class="attr">  hipchat_configs:</span></span><br><span class="line"><span class="attr">  - auth_token:</span> <span class="string">&lt;auth_token&gt;</span></span><br><span class="line"><span class="attr">    room_id:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">    message_format:</span> <span class="string">html</span></span><br><span class="line"><span class="attr">    notify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<ul>
<li><p>global<br>smtp_smarthost、smtp_from、smtp_auth_username、smtp_auth_password用于设置smtp邮件的地址及用户信息<br>hipchat_auth_token与安全性认证有关</p>
</li>
<li><p>templates<br>指定告警信息展示的模版</p>
</li>
<li><p>route<br>group_by：指定所指定的维度对告警进行分组<br>group_wait:指定每组告警发送等待的时间<br>group_interval:指定告警调度的时间间隔<br>repeat_interval:在连续告警触发的情况下，重复发送告警的时间间隔</p>
</li>
<li>receiver<br>指定告警默认的接受者</li>
<li>routes<br>match_re:定义告警接收者的匹配方式<br>service:定义匹配的方式，纬度service值以foo1或foo2或baz开始/结束时表示匹配成功<br>receiver：定义了匹配成功的的情况下的接受者</li>
<li>inhibit_rules<br>定义告警的抑制条件，过滤不必要的告警</li>
<li>receivers<br>定义了具体的接收者，也就是告警具体的方式方式</li>
</ul>
<h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span>     <span class="number">15</span><span class="string">s</span> <span class="comment"># By default, scrape targets every 15 seconds.</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span> <span class="comment"># By default, scrape targets every 15 seconds.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Attach these labels to any time series or alerts when communicating with</span></span><br><span class="line">  <span class="comment"># external systems (federation, remote storage, Alertmanager).</span></span><br><span class="line"><span class="attr">  external_labels:</span></span><br><span class="line"><span class="attr">      monitor:</span> <span class="string">'codelab-monitor'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load and evaluate rules in this file every 'evaluation_interval' seconds.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - "first.rules"</span></span><br><span class="line">  <span class="comment"># - "second.rules"</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"alert.rules"</span></span><br><span class="line">  <span class="comment"># - "record.rules"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it's Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'windows-test'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line"><span class="attr">    scrape_interval:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">    <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['192.168.3.1:9090','192.168.3.120:9090']</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'windows-chenx'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line"><span class="attr">    scrape_interval:</span> <span class="number">3</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">    <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['192.168.3.1:9091']</span></span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>global下的scrape_interval<br>用于向pushgateway采集数据的频率，上图所示：每隔15秒向pushgateway采集一次指标数据</li>
<li>global下的evaluation_interval<br>表示规则计算的频率，上图所示：每隔15秒根据所配置的规则集，进行规则计算</li>
<li>global下的external_labels<br>为指标增加额外的维度，可用于区分不同的prometheus,在应用中多个prometheus可以对应一个alertmanager</li>
<li>rule_files<br>指定所配置规则文件，文件中每行可表示一个规则</li>
<li>scrape_configs下的job_name<br>指定任务名称，在指标中会增加该维度，表示该指标所属的job</li>
<li>scrape_configs下的scrape_interval<br>覆盖global下的scrape_interval配置</li>
<li>static_configs下的targets<br>指定指标数据源的地址，多个地址之间用逗号隔开</li>
</ul>
<h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><h3 id="告警路由"><a href="#告警路由" class="headerlink" title="告警路由"></a>告警路由</h3><p>路由字段即route的配置他控制了告警的聚合以及发送频率，route字段本身是一个树状的，每一个节点是一个配置，配置包括了接收人、match字段以及相应的告警发送配置例如：首次聚合时间、告警后续发送频率。对于到达的告警会收心进行match，如果有一个节点match并且该节点的continue字段为true，那么会继续递归遍历它的子节点，直到到达最后一个，这样就把匹配到同一个节点的告警经过group_by字段的分类，放置在不同的<strong>簇</strong>里面，这样就完成了告警的聚合功能。</p>
<p>这里有一点需要着重指出的一点是，对于每个簇，有三个字段影响了告警发送的频率，<strong>group_wait、group_interval、repeat_interval</strong>。</p>
<p>group_wait:当告警A第一次到达之后由于之前并没有告警簇，此时会进行创建，创建完之后会等待group_wait时间之后才会进行发送，这是为什么呢？这其实是为了解决告警风暴的问题，例如当服务集群a发生了告警，例如有10条，如果他们在group_wait这段时间内相继到达，那么最终他们就会被合并成一条告警进行发送。而不是收到10次告警信息。</p>
<p>group_interval:控制的是遍历告警簇的时间间隔，am当中当有新的告警到达时（之前没有进行过发生的告警）会进行告警簇的发送或者当检测到上次告警发送时间距离当前时间已经大于<strong>repeat_interval</strong>那么此时会进行发送。</p>
<p>路由配置格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#报警接收器</span></span><br><span class="line"><span class="string">[</span> <span class="attr">receiver:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#分组</span></span><br><span class="line"><span class="string">[</span> <span class="attr">group_by:</span> <span class="string">'['</span> <span class="string">&lt;labelname&gt;,</span> <span class="string">...</span> <span class="string">']'</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether an alert should continue matching subsequent sibling nodes.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">continue:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">| default = false ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># A set of equality matchers an alert has to fulfill to match the node.</span></span><br><span class="line"><span class="string">#根据匹配的警报，指定接收器</span></span><br><span class="line"><span class="string"></span><span class="attr">match:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A set of regex-matchers an alert has to fulfill to match the node.</span></span><br><span class="line"><span class="attr">match_re:</span></span><br><span class="line"><span class="comment">#根据匹配正则符合的警告，指定接收器</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;regex&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How long to initially wait to send a notification for a group</span></span><br><span class="line"><span class="comment"># of alerts. Allows to wait for an inhibiting alert to arrive or collect</span></span><br><span class="line"><span class="comment"># more initial alerts for the same group. (Usually ~0s to few minutes.)</span></span><br><span class="line"><span class="string">[</span> <span class="attr">group_wait:</span> <span class="string">&lt;duration&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How long to wait before sending notification about new alerts that are</span></span><br><span class="line"><span class="comment"># in are added to a group of alerts for which an initial notification</span></span><br><span class="line"><span class="comment"># has already been sent. (Usually ~5min or more.)</span></span><br><span class="line"><span class="string">[</span> <span class="attr">group_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How long to wait before sending a notification again if it has already</span></span><br><span class="line"><span class="comment"># been sent successfully for an alert. (Usually ~3h or more).</span></span><br><span class="line"><span class="string">[</span> <span class="attr">repeat_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Zero or more child routes.</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;route&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The root route with all parameters, which are inherited by the child</span></span><br><span class="line"><span class="comment"># routes if they are not overwritten.</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="attr">  receiver:</span> <span class="string">'default-receiver'</span></span><br><span class="line"><span class="attr">  group_wait:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">  group_interval:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">  repeat_interval:</span> <span class="number">4</span><span class="string">h</span></span><br><span class="line"><span class="attr">  group_by:</span> <span class="string">[cluster,</span> <span class="string">alertname]</span></span><br><span class="line">  <span class="comment"># All alerts that do not match the following child routes</span></span><br><span class="line">  <span class="comment"># will remain at the root node and be dispatched to 'default-receiver'.</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line">  <span class="comment"># All alerts with service=mysql or service=cassandra</span></span><br><span class="line">  <span class="comment"># are dispatched to the database pager.</span></span><br><span class="line"><span class="attr">  - receiver:</span> <span class="string">'database-pager'</span></span><br><span class="line"><span class="attr">    group_wait:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">    match_re:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">mysql|cassandra</span></span><br><span class="line">  <span class="comment"># All alerts with the team=frontend label match this sub-route.</span></span><br><span class="line">  <span class="comment"># They are grouped by product and environment rather than cluster</span></span><br><span class="line">  <span class="comment"># and alertname.</span></span><br><span class="line"><span class="attr">  - receiver:</span> <span class="string">'frontend-pager'</span></span><br><span class="line"><span class="attr">    group_by:</span> <span class="string">[product,</span> <span class="string">environment]</span></span><br><span class="line"><span class="attr">    match:</span></span><br><span class="line"><span class="attr">      team:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>
<h3 id="告警聚合"><a href="#告警聚合" class="headerlink" title="告警聚合"></a>告警聚合</h3><p>告警聚合是非常重要的一个功能，好的聚合可以极大的减少告警风暴。</p>
<p>告警聚合在路由之后，每个路由节点可以配置自己的独特的聚合labels，比如按产品、集群、team等聚合。</p>
<p>例如上述示例，只按产品聚合，那么所有属于产品tcs的告警将与该告警一起聚合，所有属于产品tcs的告警都会放到一起，这种比较杂乱；如果按产品和类型聚合，那么属于不同机器的告警将分别聚合。</p>
<h3 id="告警抑制"><a href="#告警抑制" class="headerlink" title="告警抑制"></a>告警抑制</h3><p>告警抑制是指高等级告警发生时，自动抑制低等级的告警发送，同时当高等级告警恢复是，放开对低等级的抑制，常见场景是磁盘满80%警告告警通知，90%发送严重告警通知。</p>
<p>告警抑制的实现也是基于labels，但是是基于全局的，不是特定路由，而且只支持静态label，这个地方的设计其实不太好，有两个问题：</p>
<ol>
<li>全局容易出现不同用户的规则互相影响，为了减少此种行为的发生，我们应该为每个路由设定一个抑制规则，同时必须包含路由的labels</li>
<li>静态label对label规范化增加了不必要的限制，所有数据都必须拥有指定的抑制labels才能使用</li>
</ol>
<h3 id="告警屏蔽"><a href="#告警屏蔽" class="headerlink" title="告警屏蔽"></a>告警屏蔽</h3><p>告警屏蔽和告警抑制有点类似，但不一样，告警屏蔽是直接屏蔽报警，不再发送，不同报警之间无关联（告警抑制是高等级告警抑制低等级告警）。告警屏蔽也是基于labels，当告警中包含的labels满足(match)配置的屏蔽labels，就会发生屏蔽，不再发送告警。</p>
<p>原生的alertmanger屏蔽会直接在内存中屏蔽告警，无法记录到底哪些告警被屏蔽了，而且一旦屏蔽，及时报警恢复也不会发送通知，一旦设定，只能等屏蔽过期或者手工删除。</p>
<p>370对记录告警是个强需求，我们改造了alertmanager，让被屏蔽的告警也能继续发出来，但会加一个特殊的标记，这样我们就可以记录被屏蔽告警的信息，也可以捕获恢复。</p>
<p>抑制配置格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Matchers that have to be fulfilled in the alerts to be muted.</span></span><br><span class="line"><span class="comment">##必须在要需要静音的警报中履行的匹配者</span></span><br><span class="line"><span class="attr">target_match:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">target_match_re:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;regex&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Matchers for which one or more alerts have to exist for the</span></span><br><span class="line"><span class="comment"># inhibition to take effect.</span></span><br><span class="line"><span class="comment">#必须存在一个或多个警报以使抑制生效的匹配者。</span></span><br><span class="line"><span class="attr">source_match:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">source_match_re:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;regex&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Labels that must have an equal value in the source and target</span></span><br><span class="line"><span class="comment"># alert for the inhibition to take effect.</span></span><br><span class="line"><span class="comment">#在源和目标警报中必须具有相等值的标签才能使抑制生效</span></span><br><span class="line"><span class="string">[</span> <span class="attr">equal:</span> <span class="string">'['</span> <span class="string">&lt;labelname&gt;,</span> <span class="string">...</span> <span class="string">']'</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<h3 id="告警发送"><a href="#告警发送" class="headerlink" title="告警发送"></a>告警发送</h3><p>告警发送是告警系统的最后一个处理点，也是众口难调的一个点，目前支持常见的第三方组件，但都不好用，且无法定制，一般都会基于webhook设计适合公司的发送能力。</p>
<p>通用配置格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The unique name of the receiver.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configurations for several notification integrations.</span></span><br><span class="line"><span class="attr">email_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;email_config&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">pagerduty_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;pagerduty_config&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">slack_config:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;slack_config&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">opsgenie_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;opsgenie_config&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;webhook_config&gt;,</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>邮件接收器email_config</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Whether or not to notify about resolved alerts.</span></span><br><span class="line"><span class="comment">#警报被解决之后是否通知</span></span><br><span class="line"><span class="string">[</span> <span class="attr">send_resolved:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">| default = false ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># The email address to send notifications to.</span></span><br><span class="line"><span class="string"></span><span class="attr">to:</span> <span class="string">&lt;tmpl_string&gt;</span></span><br><span class="line"><span class="comment"># The sender address.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">from:</span> <span class="string">&lt;tmpl_string&gt;</span> <span class="string">| default = global.smtp_from ]</span></span><br><span class="line"><span class="string"># The SMTP host through which emails are sent.</span></span><br><span class="line"><span class="string">[ smarthost: &lt;string&gt; | default = global.smtp_smarthost ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># The HTML body of the email notification.</span></span><br><span class="line"><span class="string">[ html: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "email.default.html" . &#125;&#125;</span>' ] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Further headers email header key/value pairs. Overrides any headers</span></span><br><span class="line"><span class="string"># previously set by the notification implementation.</span></span><br><span class="line"><span class="string">[ headers: &#123; &lt;string&gt;: &lt;tmpl_string&gt;, ... &#125; ]</span></span><br></pre></td></tr></table></figure>
<p>Slcack接收器slack_config</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Whether or not to notify about resolved alerts.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">send_resolved:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">| default = true ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># The Slack webhook URL.</span></span><br><span class="line"><span class="string">[ api_url: &lt;string&gt; | default = global.slack_api_url ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># The channel or user to send notifications to.</span></span><br><span class="line"><span class="string"></span><span class="attr">channel:</span> <span class="string">&lt;tmpl_string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># API request data as defined by the Slack webhook API.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">color:</span> <span class="string">&lt;tmpl_string&gt;</span> <span class="string">| default = '<span class="template-variable">&#123;&#123; if eq .Status "firing" &#125;&#125;</span>danger<span class="template-variable">&#123;&#123; else &#125;&#125;</span>good<span class="template-variable">&#123;&#123; end &#125;&#125;</span>' ]</span></span><br><span class="line"><span class="string">[ username: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "slack.default.username" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="string">[ title: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "slack.default.title" . &#125;&#125;</span>' ]</span></span><br><span class="line"><span class="string">[ title_link: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "slack.default.titlelink" . &#125;&#125;</span>' ]</span></span><br><span class="line"><span class="string">[ pretext: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "slack.default.pretext" . &#125;&#125;</span>' ]</span></span><br><span class="line"><span class="string">[ text: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "slack.default.text" . &#125;&#125;</span>' ]</span></span><br><span class="line"><span class="string">[ fallback: &lt;tmpl_string&gt; | default = '<span class="template-variable">&#123;&#123; template "slack.default.fallback" . &#125;&#125;</span>' ]</span></span><br></pre></td></tr></table></figure>
<p>Webhook接收器webhook_config</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># Whether or not to notify about resolved alerts.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">send_resolved:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">| default = true ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> # The endpoint to send HTTP POST requests to.</span></span><br><span class="line"><span class="string"></span><span class="attr">url:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure>
<p>Alertmanager会使用以下的格式向配置端点发送HTTP POST请求：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"3"</span>,</span><br><span class="line">  <span class="attr">"groupKey"</span>: &lt;number&gt;     // key identifying the group of alerts (e.g. to deduplicate)</span><br><span class="line">  <span class="string">"status"</span>: <span class="string">"&lt;resolved|firing&gt;"</span>,</span><br><span class="line">  <span class="attr">"receiver"</span>: &lt;string&gt;,</span><br><span class="line">  <span class="attr">"groupLabels"</span>: &lt;object&gt;,</span><br><span class="line">  <span class="attr">"commonLabels"</span>: &lt;object&gt;,</span><br><span class="line">  <span class="attr">"commonAnnotations"</span>: &lt;object&gt;,</span><br><span class="line">  "externalURL": &lt;string&gt;,  // backling to the Alertmanager.</span><br><span class="line">  "alerts": [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"labels"</span>: &lt;object&gt;,</span><br><span class="line">      <span class="attr">"annotations"</span>: &lt;object&gt;,</span><br><span class="line">      <span class="attr">"startsAt"</span>: <span class="string">"&lt;rfc3339&gt;"</span>,</span><br><span class="line">      <span class="attr">"endsAt"</span>: <span class="string">"&lt;rfc3339&gt;"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以添加一个钉钉webhook，通过<a href="https://link.jianshu.com/?t=!https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.karFPe&amp;treeId=257&amp;articleId=105735&amp;docType=1" target="_blank" rel="external">钉钉报警</a>,由于POST数据需要有要求，简单实现一个数据转发脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        post_data = request.get_data()</span><br><span class="line">        alert_data(post_data)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alert_data</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">from</span> urllib2 <span class="keyword">import</span> Request,urlopen</span><br><span class="line">    url = <span class="string">'https://oapi.dingtalk.com/robot/send?access_token=xxxx'</span></span><br><span class="line">    send_data = <span class="string">'&#123;"msgtype": "text","text": &#123;"content": %s&#125;&#125;'</span> %(data)</span><br><span class="line">    request = Request(url, send_data)</span><br><span class="line">    request.add_header(<span class="string">'Content-Type'</span>,<span class="string">'application/json'</span>)</span><br><span class="line">    <span class="keyword">return</span> urlopen(request).read()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="报警规则"><a href="#报警规则" class="headerlink" title="报警规则"></a>报警规则</h3><p>报警规则允许你定义基于Prometheus<a href="https://link.jianshu.com/?t=!https://prometheus.io/docs/querying/basics/" target="_blank" rel="external">表达式语言</a>的报警条件，并发送报警通知到外部服务</p>
<p>报警规则通过以下格式定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ALERT &lt;alert name&gt;</span><br><span class="line">  IF &lt;expression&gt;</span><br><span class="line">  [ FOR &lt;duration&gt; ]</span><br><span class="line">  [ LABELS &lt;label set&gt; ]</span><br><span class="line">  [ ANNOTATIONS &lt;label set&gt; ]</span><br></pre></td></tr></table></figure>
<p>可选的FOR语句，使得Prometheus在表达式输出的向量元素（例如高HTTP错误率的实例）之间等待一段时间，将警报计数作为触发此元素。如果元素是active，但是没有firing的，就处于pending状态。</p>
<p>LABELS（标签）语句允许指定一组标签附加警报上。将覆盖现有冲突的任何标签，标签值也可以被模板化。</p>
<p>ANNOTATIONS（注释）它们被用于存储更长的其他信息，例如警报描述或者链接，注释值也可以被模板化。</p>
<p>Templating(模板) 标签和注释值可以使用<a href="https://link.jianshu.com?t=!https://prometheus.io/docs/visualization/consoles/" target="_blank" rel="external">控制台模板</a>进行模板化。$labels变量保存警报实例的标签键/值对，$value保存警报实例的评估值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># To insert a firing element&apos;s label values:</span><br><span class="line">&#123;&#123; $labels.&lt;labelname&gt; &#125;&#125;</span><br><span class="line"># To insert the numeric expression value of the firing element:</span><br><span class="line">&#123;&#123; $value &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>报警规则示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Alert for any instance that is unreachable for &gt;5 minutes.</span></span><br><span class="line"><span class="string">ALERT</span> <span class="string">InstanceDown</span></span><br><span class="line">  <span class="string">IF</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">  <span class="string">FOR</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="string">LABELS</span> <span class="string">&#123;</span> <span class="string">severity</span> <span class="string">=</span> <span class="string">"page"</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="string">ANNOTATIONS</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">summary</span> <span class="string">=</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down"</span><span class="string">,</span></span><br><span class="line">    <span class="string">description</span> <span class="string">=</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 5 minutes."</span><span class="string">,</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alert for any instance that have a median request latency &gt;1s.</span></span><br><span class="line"><span class="string">ALERT</span> <span class="string">APIHighRequestLatency</span></span><br><span class="line">  <span class="string">IF</span> <span class="string">api_http_request_latencies_second&#123;quantile="0.5"&#125;</span> <span class="string">&gt; 1</span></span><br><span class="line"><span class="string">  FOR 1m</span></span><br><span class="line"><span class="string">  ANNOTATIONS &#123;</span></span><br><span class="line"><span class="string">    summary = "High request latency on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>",</span></span><br><span class="line"><span class="string">    description = "<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has a median request latency above 1s (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s)",</span></span><br><span class="line"><span class="string">  &#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><p>alertmanager/cmd/alertmanager/main.go</p>
<h3 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 程序入口main函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	os.Exit(run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// run函数，真实的程序主函数。初始化，并开启相应的服务。阻塞监听reload和关闭信号，会进行平滑退出。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化集群，可高可用</span></span><br><span class="line">	<span class="keyword">var</span> peer *cluster.Peer</span><br><span class="line">	<span class="keyword">if</span> *clusterBindAddr != <span class="string">""</span> &#123;</span><br><span class="line">		peer, err = cluster.Create(</span><br><span class="line">			log.With(logger, <span class="string">"component"</span>, <span class="string">"cluster"</span>),</span><br><span class="line">			prometheus.DefaultRegisterer,</span><br><span class="line">			*clusterBindAddr,</span><br><span class="line">			*clusterAdvertiseAddr,</span><br><span class="line">			*peers,</span><br><span class="line">			<span class="literal">true</span>,</span><br><span class="line">			*pushPullInterval,</span><br><span class="line">			*gossipInterval,</span><br><span class="line">			*tcpTimeout,</span><br><span class="line">			*probeTimeout,</span><br><span class="line">			*probeInterval,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			level.Error(logger).Log(<span class="string">"msg"</span>, <span class="string">"unable to initialize gossip mesh"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 设置普罗米修斯集群指标，为已启用</span></span><br><span class="line">		clusterEnabled.Set(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 配置 stop channel 和 等待组，确保优雅退出</span></span><br><span class="line">	stopc := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 配置集群广播日志信息配置，并配置广播？？？</span></span><br><span class="line">	notificationLogOpts := []nflog.Option&#123;</span><br><span class="line">		nflog.WithRetention(*retention),</span><br><span class="line">		nflog.WithSnapshot(filepath.Join(*dataDir, <span class="string">"nflog"</span>)),</span><br><span class="line">		nflog.WithMaintenance(<span class="number">15</span>*time.Minute, stopc, wg.Done),</span><br><span class="line">		nflog.WithMetrics(prometheus.DefaultRegisterer),</span><br><span class="line">		nflog.WithLogger(log.With(logger, <span class="string">"component"</span>, <span class="string">"nflog"</span>)),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	notificationLog, err := nflog.New(notificationLogOpts...)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		level.Error(logger).Log(<span class="string">"err"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> peer != <span class="literal">nil</span> &#123;</span><br><span class="line">		c := peer.AddState(<span class="string">"nfl"</span>, notificationLog, prometheus.DefaultRegisterer)</span><br><span class="line">		notificationLog.SetBroadcast(c.Broadcast)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marker := types.NewMarker(prometheus.DefaultRegisterer)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 静默配置，并生成静默对象，如果有配置集群，则设置集群广播。</span></span><br><span class="line">	silenceOpts := silence.Options&#123;</span><br><span class="line">		SnapshotFile: filepath.Join(*dataDir, <span class="string">"silences"</span>),</span><br><span class="line">		Retention:    *retention,</span><br><span class="line">		Logger:       log.With(logger, <span class="string">"component"</span>, <span class="string">"silences"</span>),</span><br><span class="line">		Metrics:      prometheus.DefaultRegisterer,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	silences, err := silence.New(silenceOpts)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		level.Error(logger).Log(<span class="string">"err"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> peer != <span class="literal">nil</span> &#123;</span><br><span class="line">		c := peer.AddState(<span class="string">"sil"</span>, silences, prometheus.DefaultRegisterer)</span><br><span class="line">		silences.SetBroadcast(c.Broadcast)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start providers before router potentially sends updates.</span></span><br><span class="line">	wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="comment">// 维护静默产生的data数据，每十五分钟进行下数据删除。</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		silences.Maintenance(<span class="number">15</span>*time.Minute, filepath.Join(*dataDir, <span class="string">"silences"</span>), stopc)</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// defer wg.Wait 确保最后所有的任务都优雅退出之后，才会程序退出。</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="built_in">close</span>(stopc)</span><br><span class="line">		wg.Wait()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 集群peer的状态监听器已经进行注册成功，现在可以进行加入集群和初始化状态。</span></span><br><span class="line">	<span class="comment">// Peer state listeners have been registered, now we can join and get the initial state.</span></span><br><span class="line">	<span class="keyword">if</span> peer != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = peer.Join(</span><br><span class="line">			*reconnectInterval,</span><br><span class="line">			*peerReconnectTimeout,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			level.Warn(logger).Log(<span class="string">"msg"</span>, <span class="string">"unable to join gossip mesh"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		ctx, cancel := context.WithTimeout(context.Background(), *settleTimeout)</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			cancel()</span><br><span class="line">			<span class="keyword">if</span> err := peer.Leave(<span class="number">10</span> * time.Second); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				level.Warn(logger).Log(<span class="string">"msg"</span>, <span class="string">"unable to leave gossip mesh"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">go</span> peer.Settle(ctx, *gossipInterval*<span class="number">10</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建监控对象</span></span><br><span class="line">	alerts, err := mem.NewAlerts(context.Background(), marker, *alertGCInterval, logger)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		level.Error(logger).Log(<span class="string">"err"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> alerts.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> disp *dispatch.Dispatcher</span><br><span class="line">	<span class="keyword">defer</span> disp.Stop()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建分组方法</span></span><br><span class="line">	groupFn := <span class="function"><span class="keyword">func</span><span class="params">(routeFilter <span class="keyword">func</span>(*dispatch.Route)</span> <span class="title">bool</span>, <span class="title">alertFilter</span> <span class="title">func</span><span class="params">(*types.Alert, time.Time)</span> <span class="title">bool</span>) <span class="params">(dispatch.AlertGroups, <span class="keyword">map</span>[model.Fingerprint][]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> disp.Groups(routeFilter, alertFilter)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// alertmanager api结构体，包含所有版本V1,V2的http接口。</span></span><br><span class="line">	api, err := api.New(api.Options&#123;</span><br><span class="line">		Alerts:      alerts,</span><br><span class="line">		Silences:    silences,</span><br><span class="line">		StatusFunc:  marker.Status,</span><br><span class="line">		Peer:        peer,</span><br><span class="line">		Timeout:     *httpTimeout,</span><br><span class="line">		Concurrency: *getConcurrency,</span><br><span class="line">		Logger:      log.With(logger, <span class="string">"component"</span>, <span class="string">"api"</span>),</span><br><span class="line">		Registry:    prometheus.DefaultRegisterer,</span><br><span class="line">		GroupFunc:   groupFn,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		level.Error(logger).Log(<span class="string">"err"</span>, errors.Wrap(err, <span class="string">"failed to create API"</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	amURL, err := extURL(logger, os.Hostname, *listenAddress, *externalURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		level.Error(logger).Log(<span class="string">"msg"</span>, <span class="string">"failed to determine external URL"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	level.Debug(logger).Log(<span class="string">"externalURL"</span>, amURL.String())</span><br><span class="line"></span><br><span class="line">	waitFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Duration</span></span> &#123; <span class="keyword">return</span> <span class="number">0</span> &#125;</span><br><span class="line">	<span class="keyword">if</span> peer != <span class="literal">nil</span> &#123;</span><br><span class="line">		waitFunc = clusterWait(peer, *peerTimeout)</span><br><span class="line">	&#125;</span><br><span class="line">	timeoutFunc := <span class="function"><span class="keyword">func</span><span class="params">(d time.Duration)</span> <span class="title">time</span>.<span class="title">Duration</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> d &lt; notify.MinTimeout &#123;</span><br><span class="line">			d = notify.MinTimeout</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> d + waitFunc()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		inhibitor *inhibit.Inhibitor</span><br><span class="line">		tmpl      *template.Template</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建普罗米修斯相关统计指标，创建配置协调者。</span></span><br><span class="line">	dispMetrics := dispatch.NewDispatcherMetrics(prometheus.DefaultRegisterer)</span><br><span class="line">	pipelineBuilder := notify.NewPipelineBuilder(prometheus.DefaultRegisterer)</span><br><span class="line">	configLogger := log.With(logger, <span class="string">"component"</span>, <span class="string">"configuration"</span>)</span><br><span class="line">	configCoordinator := config.NewCoordinator(</span><br><span class="line">		*configFile,</span><br><span class="line">		prometheus.DefaultRegisterer,</span><br><span class="line">		configLogger,</span><br><span class="line">	)</span><br><span class="line">	configCoordinator.Subscribe(<span class="function"><span class="keyword">func</span><span class="params">(conf *config.Config)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		tmpl, err = template.FromGlobs(conf.Templates...)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Wrap(err, <span class="string">"failed to parse templates"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		tmpl.ExternalURL = amURL</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Build the routing tree and record which receivers are used.</span></span><br><span class="line">		<span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">		<span class="comment">// 建立路由树和记录下被使用的接收人</span></span><br><span class="line">		routes := dispatch.NewRoute(conf.Route, <span class="literal">nil</span>)</span><br><span class="line">		activeReceivers := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">		routes.Walk(<span class="function"><span class="keyword">func</span><span class="params">(r *dispatch.Route)</span></span> &#123;</span><br><span class="line">			activeReceivers[r.RouteOpts.Receiver] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Build the map of receiver to integrations.</span></span><br><span class="line">		receivers := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]notify.Integration, <span class="built_in">len</span>(activeReceivers))</span><br><span class="line">		<span class="keyword">var</span> integrationsNum <span class="keyword">int</span></span><br><span class="line">		<span class="comment">// 循环加载所有配置中的接受消息人</span></span><br><span class="line">		<span class="keyword">for</span> _, rcv := <span class="keyword">range</span> conf.Receivers &#123;</span><br><span class="line">			<span class="comment">// 查看此接受消息人，没有任何route在使用，则进行记录和丢弃，然后开始下一轮。</span></span><br><span class="line">			<span class="keyword">if</span> _, found := activeReceivers[rcv.Name]; !found &#123;</span><br><span class="line">				<span class="comment">// No need to build a receiver if no route is using it.</span></span><br><span class="line">				level.Info(configLogger).Log(<span class="string">"msg"</span>, <span class="string">"skipping creation of receiver not referenced by any route"</span>, <span class="string">"receiver"</span>, rcv.Name)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 创建接收人的integration，并插入到receiver map中。</span></span><br><span class="line">			integrations, err := buildReceiverIntegrations(rcv, tmpl, logger)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// rcv.Name is guaranteed to be unique across all receivers.</span></span><br><span class="line">			receivers[rcv.Name] = integrations</span><br><span class="line">			integrationsNum += <span class="built_in">len</span>(integrations)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 停止抑制器和调度器</span></span><br><span class="line">		inhibitor.Stop()</span><br><span class="line">		disp.Stop()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 创建静默，抑制器并放到pipeline里面，pipeline包含告警处理的每一个stage。</span></span><br><span class="line">		inhibitor = inhibit.NewInhibitor(alerts, conf.InhibitRules, marker, logger)</span><br><span class="line">		silencer := silence.NewSilencer(silences, marker, logger)</span><br><span class="line">		pipeline := pipelineBuilder.New(</span><br><span class="line">			receivers,</span><br><span class="line">			waitFunc,</span><br><span class="line">			inhibitor,</span><br><span class="line">			silencer,</span><br><span class="line">			notificationLog,</span><br><span class="line">			peer,</span><br><span class="line">		)</span><br><span class="line">		configuredReceivers.Set(<span class="keyword">float64</span>(<span class="built_in">len</span>(activeReceivers)))</span><br><span class="line">		configuredIntegrations.Set(<span class="keyword">float64</span>(integrationsNum))</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新api的抑制和静默数据</span></span><br><span class="line">		api.Update(conf, <span class="function"><span class="keyword">func</span><span class="params">(labels model.LabelSet)</span></span> &#123;</span><br><span class="line">			inhibitor.Mutes(labels)</span><br><span class="line">			silencer.Mutes(labels)</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 创建alertmanager调度器</span></span><br><span class="line">		disp = dispatch.NewDispatcher(alerts, routes, pipeline, marker, timeoutFunc, logger, dispMetrics)</span><br><span class="line">		routes.Walk(<span class="function"><span class="keyword">func</span><span class="params">(r *dispatch.Route)</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> r.RouteOpts.RepeatInterval &gt; *retention &#123;</span><br><span class="line">				level.Warn(configLogger).Log(</span><br><span class="line">					<span class="string">"msg"</span>,</span><br><span class="line">					<span class="string">"repeat_interval is greater than the data retention period. It can lead to notifications being repeated more often than expected."</span>,</span><br><span class="line">					<span class="string">"repeat_interval"</span>,</span><br><span class="line">					r.RouteOpts.RepeatInterval,</span><br><span class="line">					<span class="string">"retention"</span>,</span><br><span class="line">					*retention,</span><br><span class="line">					<span class="string">"route"</span>,</span><br><span class="line">					r.Key(),</span><br><span class="line">				)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 独立协成去运行调度器和抑制器</span></span><br><span class="line">		<span class="keyword">go</span> disp.Run()</span><br><span class="line">		<span class="keyword">go</span> inhibitor.Run()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := configCoordinator.Reload(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make routePrefix default to externalURL path if empty string.</span></span><br><span class="line">	<span class="keyword">if</span> *routePrefix == <span class="string">""</span> &#123;</span><br><span class="line">		*routePrefix = amURL.Path</span><br><span class="line">	&#125;</span><br><span class="line">	*routePrefix = <span class="string">"/"</span> + strings.Trim(*routePrefix, <span class="string">"/"</span>)</span><br><span class="line">	level.Debug(logger).Log(<span class="string">"routePrefix"</span>, *routePrefix)</span><br><span class="line"></span><br><span class="line">	router := route.New().WithInstrumentation(instrumentHandler)</span><br><span class="line">	<span class="keyword">if</span> *routePrefix != <span class="string">"/"</span> &#123;</span><br><span class="line">		router.Get(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">			http.Redirect(w, r, *routePrefix, http.StatusFound)</span><br><span class="line">		&#125;)</span><br><span class="line">		router = router.WithPrefix(*routePrefix)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	webReload := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> error)</span><br><span class="line"></span><br><span class="line">	ui.Register(router, webReload, logger)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从api中获取Handler mux</span></span><br><span class="line">	mux := api.Register(router, *routePrefix)</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中大部分都有注释，基本都是一些初始化的操作，看下几个重要的点</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> disp.Run() <span class="comment">// 告警聚合</span></span><br><span class="line"><span class="keyword">go</span> inhibitor.Run() <span class="comment">// 告警抑制</span></span><br><span class="line">mux := api.Register(router, *routePrefix) <span class="comment">// 告警api，包含接收告警和实现告警屏蔽</span></span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// alertmanager/api/v1/api.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *API)</span> <span class="title">Register</span><span class="params">(r *route.Router)</span></span> &#123;</span><br><span class="line">	wrap := <span class="function"><span class="keyword">func</span><span class="params">(f http.HandlerFunc)</span> <span class="title">http</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">			setCORS(w)</span><br><span class="line">			f(w, r)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.Options(<span class="string">"/*path"</span>, wrap(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;&#125;))</span><br><span class="line"></span><br><span class="line">	r.Get(<span class="string">"/status"</span>, wrap(api.status))</span><br><span class="line">	r.Get(<span class="string">"/receivers"</span>, wrap(api.receivers))</span><br><span class="line"></span><br><span class="line">	r.Get(<span class="string">"/alerts"</span>, wrap(api.listAlerts))</span><br><span class="line">	r.Post(<span class="string">"/alerts"</span>, wrap(api.addAlerts)) <span class="comment">// 接收来自其余服务的告警（prometheus）</span></span><br><span class="line"></span><br><span class="line">	r.Get(<span class="string">"/silences"</span>, wrap(api.listSilences)) </span><br><span class="line">	r.Post(<span class="string">"/silences"</span>, wrap(api.setSilence)) <span class="comment">// 告警屏蔽</span></span><br><span class="line">	r.Get(<span class="string">"/silence/:sid"</span>, wrap(api.getSilence))</span><br><span class="line">	r.Del(<span class="string">"/silence/:sid"</span>, wrap(api.delSilence))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们每个模块单独分析，首先这里的api肯定是有服务调用才会运行，所以我们先不管这边，先看下初始化的时候，alertmanager都做了什么事情。</p>
<h3 id="告警聚合初始化"><a href="#告警聚合初始化" class="headerlink" title="告警聚合初始化"></a>告警聚合初始化</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go disp.Run()</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dispatcher)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 初始化结束通道</span></span><br><span class="line">	d.done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	d.mtx.Lock()</span><br><span class="line">	d.aggrGroups = <span class="keyword">map</span>[*Route]<span class="keyword">map</span>[model.Fingerprint]*aggrGroup&#123;&#125;</span><br><span class="line">	d.metrics.aggrGroups.Set(<span class="number">0</span>)</span><br><span class="line">	d.ctx, d.cancel = context.WithCancel(context.Background())</span><br><span class="line">	d.mtx.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 运行调度器子运行函数</span></span><br><span class="line">	d.run(d.alerts.Subscribe())</span><br><span class="line">	<span class="built_in">close</span>(d.done)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dispatcher)</span> <span class="title">run</span><span class="params">(it provider.AlertIterator)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建清理ticker，其负责每30秒，检查所有的告警分组。</span></span><br><span class="line">	cleanup := time.NewTicker(<span class="number">30</span> * time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cleanup.Stop()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> it.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="comment">// 收到告警事件</span></span><br><span class="line">		<span class="keyword">case</span> alert, ok := &lt;-it.Next():</span><br><span class="line">			<span class="comment">// 如果告警的通道被关闭，而且数据已经读取完毕，则返回。</span></span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="comment">// Iterator exhausted for some reason.</span></span><br><span class="line">				<span class="comment">// ------------------------------------</span></span><br><span class="line">				<span class="comment">// 记录下alert遍历器的错误</span></span><br><span class="line">				<span class="keyword">if</span> err := it.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					level.Error(d.logger).Log(<span class="string">"msg"</span>, <span class="string">"Error on alert update"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			level.Debug(d.logger).Log(<span class="string">"msg"</span>, <span class="string">"Received alert"</span>, <span class="string">"alert"</span>, alert)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Log errors but keep trying.</span></span><br><span class="line">			<span class="comment">// ----------------------------------</span></span><br><span class="line">			<span class="comment">// 检查遍历器的错误，如果有错误则直接跳到下个循环</span></span><br><span class="line">			<span class="keyword">if</span> err := it.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				level.Error(d.logger).Log(<span class="string">"msg"</span>, <span class="string">"Error on alert update"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 根据这个告警的所有label来匹配分组，对匹配上的路由和告警进行处理</span></span><br><span class="line">			now := time.Now()</span><br><span class="line">			<span class="keyword">for</span> _, r := <span class="keyword">range</span> d.route.Match(alert.Labels) &#123;</span><br><span class="line">				d.processAlert(alert, r)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 记录处理这个告警的时间到普罗米修斯指标中</span></span><br><span class="line">			d.metrics.processingDuration.Observe(time.Since(now).Seconds())</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> &lt;-cleanup.C: <span class="comment">// 清理周期</span></span><br><span class="line">			<span class="comment">// 锁住调度器锁</span></span><br><span class="line">			d.mtx.Lock()</span><br><span class="line">			<span class="comment">// 循环分组列表，并查看每个分组下的唯一标识分组</span></span><br><span class="line">			<span class="keyword">for</span> _, groups := <span class="keyword">range</span> d.aggrGroups &#123;</span><br><span class="line">				<span class="keyword">for</span> _, ag := <span class="keyword">range</span> groups &#123;</span><br><span class="line">					<span class="comment">// 如果这个唯一标识分组为空，终止并删除分组。</span></span><br><span class="line">					<span class="comment">// 普罗米修斯计数-1</span></span><br><span class="line">					<span class="keyword">if</span> ag.empty() &#123;</span><br><span class="line">						ag.stop()</span><br><span class="line">						<span class="built_in">delete</span>(groups, ag.fingerprint())</span><br><span class="line">						d.metrics.aggrGroups.Dec()</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			d.mtx.Unlock()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> &lt;-d.ctx.Done():</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到dispather起了一个run方法，调用Subscribe方法作为参数，在这里<code>case alert, ok := &lt;-it.Next()</code>等待告警事件，先不急分析Subscribe方法，我们再看下告警抑制</p>
<h3 id="告警抑制初始化"><a href="#告警抑制初始化" class="headerlink" title="告警抑制初始化"></a>告警抑制初始化</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go inhibitor.Run()</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ih *Inhibitor)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		g   run.Group</span><br><span class="line">		ctx context.Context</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建context和cancel方法</span></span><br><span class="line">	ih.mtx.Lock()</span><br><span class="line">	ctx, ih.cancel = context.WithCancel(context.Background())</span><br><span class="line">	ih.mtx.Unlock()</span><br><span class="line">	runCtx, runCancel := context.WithCancel(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 循环每个抑制规则，然后启动独立go routine去运行垃圾回收</span></span><br><span class="line">	<span class="keyword">for</span> _, rule := <span class="keyword">range</span> ih.rules &#123;</span><br><span class="line">		<span class="keyword">go</span> rule.scache.Run(runCtx, <span class="number">15</span>*time.Minute)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加抑制方法到运行组，运行组并行运行。</span></span><br><span class="line">	<span class="comment">// 在所有的方法退出时才会退出，</span></span><br><span class="line">	<span class="comment">// 有错误时将返回第一个错误，一个return后，会中断其他方法。</span></span><br><span class="line">	g.Add(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		ih.run(runCtx)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;, <span class="function"><span class="keyword">func</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">		runCancel()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := g.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		level.Warn(ih.logger).Log(<span class="string">"msg"</span>, <span class="string">"error running inhibitor"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行抑制器，会开始订阅告警。然后开始循环，如果订阅的告警遍历器里面有告警，</span></span><br><span class="line"><span class="comment">// 则获得告警，并循环每个抑制规则，如果匹配到</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ih *Inhibitor)</span> <span class="title">run</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 开始订阅告警</span></span><br><span class="line">	it := ih.alerts.Subscribe()</span><br><span class="line">	<span class="keyword">defer</span> it.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> a := &lt;-it.Next():</span><br><span class="line">			<span class="comment">// 得到告警，</span></span><br><span class="line">			<span class="keyword">if</span> err := it.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				level.Error(ih.logger).Log(<span class="string">"msg"</span>, <span class="string">"Error iterating alerts"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Update the inhibition rules' cache.</span></span><br><span class="line">			<span class="comment">// -----------------------------------------</span></span><br><span class="line">			<span class="comment">// 循环每个抑制rule，假如当前告警匹配上某个source。</span></span><br><span class="line">			<span class="comment">// 缓存这个告警到这个抑制rule的告警map里，map的key</span></span><br><span class="line">			<span class="comment">// 为label的finger print，value为alert。</span></span><br><span class="line">			<span class="keyword">for</span> _, r := <span class="keyword">range</span> ih.rules &#123;</span><br><span class="line">				<span class="keyword">if</span> r.SourceMatchers.Match(a.Labels) &#123;</span><br><span class="line">					<span class="keyword">if</span> err := r.scache.Set(a); err != <span class="literal">nil</span> &#123;</span><br><span class="line">						level.Error(ih.logger).Log(<span class="string">"msg"</span>, <span class="string">"error on set alert"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里也是在<code>case a := &lt;-it.Next()</code>，与聚合逻辑是一致的，都是调用的Subscribe方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Alerts 接口负责装载告警对象，并且可以提供告警的遍历器，而且可以设置或可以通过告警</span></span><br><span class="line"><span class="comment">// 指纹获得告警。全部的方法，都是协成安全。</span></span><br><span class="line"><span class="keyword">type</span> Alerts <span class="keyword">interface</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Subscribe returns an iterator over active alerts that have not been</span></span><br><span class="line">	<span class="comment">// resolved and successfully notified about.</span></span><br><span class="line">	<span class="comment">// They are not guaranteed to be in chronological order.</span></span><br><span class="line">	<span class="comment">// --------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// Subscribe 方法，返回一个告警遍历器接口。遍历器会返回还没有解决和还没有被成功</span></span><br><span class="line">	<span class="comment">// 通知出来的告警。遍历器所返回的告警，并不能保证是按照时间顺序来进行排序的。</span></span><br><span class="line">	Subscribe() AlertIterator</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetPending returns an iterator over all alerts that have</span></span><br><span class="line">	<span class="comment">// pending notifications.</span></span><br><span class="line">	<span class="comment">// --------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// GetPending 方法，返回一个告警遍历器接口。遍历器会返回在等待通知的告警。</span></span><br><span class="line">	GetPending() AlertIterator</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get returns the alert for a given fingerprint.</span></span><br><span class="line">	<span class="comment">// --------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// Get 方法，通过告警的Label指纹，来获得Alert对象。Alert对象包含的信息，如</span></span><br><span class="line">	<span class="comment">// 过期时间，更新时间，标签，告警开始时间等等。</span></span><br><span class="line">	Get(model.Fingerprint) (*types.Alert, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Put adds the given alert to the set.</span></span><br><span class="line">	<span class="comment">// --------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// Put 方法，把零到多个告警，放入此告警集合里。</span></span><br><span class="line">	Put(...*types.Alert) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Subscribe 方法返回一个告警遍历器，里面包含全部活跃的告警（没有被解决或成功通知），</span></span><br><span class="line"><span class="comment">// 这个遍历器并不能保证告警是按照时间顺序排列的。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Alerts)</span> <span class="title">Subscribe</span><span class="params">()</span> <span class="title">provider</span>.<span class="title">AlertIterator</span></span> &#123;</span><br><span class="line">	a.mtx.Lock()</span><br><span class="line">	<span class="keyword">defer</span> a.mtx.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		done   = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">		alerts = a.alerts.List()</span><br><span class="line">		ch     = <span class="built_in">make</span>(<span class="keyword">chan</span> *types.Alert, max(<span class="built_in">len</span>(alerts), alertChannelLength))</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, a := <span class="keyword">range</span> alerts &#123;</span><br><span class="line">		ch &lt;- a</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把新建告警channel，放入监听器存储到map里面。</span></span><br><span class="line">	a.listeners[a.next] = listeningAlerts&#123;alerts: ch, done: done&#125;</span><br><span class="line">	a.next++</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> provider.NewAlertIterator(ch, done, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里维护了一份map，<code>a.listeners[a.next] = listeningAlerts{alerts: ch, done: done}</code>，而上面的<code>it.Next()</code>是什么，其实就是<code>ch</code>。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewAlertIterator 返回一个 AlertIterator 接口对象，底层实现类型是通过 alertIterator 来实现。</span></span><br><span class="line"><span class="comment">// Golang典型的设计思维，实现类接口为私有类，通过实现接口的方式，暴露出公开方法。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAlertIterator</span><span class="params">(ch &lt;-<span class="keyword">chan</span> *types.Alert, done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, err error)</span> <span class="title">AlertIterator</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;alertIterator&#123;</span><br><span class="line">		ch:   ch,</span><br><span class="line">		done: done,</span><br><span class="line">		err:  err,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// alertIterator 实现了 AlertIterator 接口。以现在来说，这个实现满足现在所有providers的需求。</span></span><br><span class="line"><span class="comment">// 但是假如有新的需求，可以通过创建一个新的实现类，来实现 AlertIterator 接口，来让代码变得通用。</span></span><br><span class="line"><span class="keyword">type</span> alertIterator <span class="keyword">struct</span> &#123;</span><br><span class="line">	ch   &lt;-<span class="keyword">chan</span> *types.Alert <span class="comment">// ch   元素用来遍历告警的队列。</span></span><br><span class="line">	done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;       <span class="comment">// done 是用来通知这个遍历器被关闭。</span></span><br><span class="line">	err  error               <span class="comment">// err  用来存储是否有错误，当调用完 Next 方法后，需要拿到 err 判断是否有错误。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next 方法，获取下一个告警。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ai alertIterator)</span> <span class="title">Next</span><span class="params">()</span> &lt;-<span class="title">chan</span> *<span class="title">types</span>.<span class="title">Alert</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> ai.ch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Inhibitor和Dispatcher在初始化时会调用Subscribe()，然后一直监听并接收新的alerts</p>
<p>到这里就初始化完成了，因为刚开始没有告警产生，所以两个逻辑都在<code>case</code>中阻塞，下面分析一下api的逻辑</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *API)</span> <span class="title">addAlerts</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> alerts []*types.Alert</span><br><span class="line">	<span class="keyword">if</span> err := api.receive(r, &amp;alerts); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		api.respondError(w, apiError&#123;</span><br><span class="line">			typ: errorBadData,</span><br><span class="line">			err: err,</span><br><span class="line">		&#125;, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	api.insertAlerts(w, r, alerts...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *API)</span> <span class="title">insertAlerts</span><span class="params">(w http.ResponseWriter, r *http.Request, alerts ...*types.Alert)</span></span> &#123;</span><br><span class="line">	now := time.Now()</span><br><span class="line"></span><br><span class="line">	api.mtx.RLock()</span><br><span class="line">	resolveTimeout := time.Duration(api.config.Global.ResolveTimeout)</span><br><span class="line">	api.mtx.RUnlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, alert := <span class="keyword">range</span> alerts &#123;</span><br><span class="line">		alert.UpdatedAt = now</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ensure StartsAt is set.</span></span><br><span class="line">		<span class="keyword">if</span> alert.StartsAt.IsZero() &#123;</span><br><span class="line">			<span class="keyword">if</span> alert.EndsAt.IsZero() &#123;</span><br><span class="line">				alert.StartsAt = now</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				alert.StartsAt = alert.EndsAt</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// If no end time is defined, set a timeout after which an alert</span></span><br><span class="line">		<span class="comment">// is marked resolved if it is not updated.</span></span><br><span class="line">		<span class="keyword">if</span> alert.EndsAt.IsZero() &#123;</span><br><span class="line">			alert.Timeout = <span class="literal">true</span></span><br><span class="line">			alert.EndsAt = now.Add(resolveTimeout)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> alert.EndsAt.After(time.Now()) &#123;</span><br><span class="line">			api.m.Firing().Inc()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			api.m.Resolved().Inc()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make a best effort to insert all alerts that are valid.</span></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		validAlerts    = <span class="built_in">make</span>([]*types.Alert, <span class="number">0</span>, <span class="built_in">len</span>(alerts))</span><br><span class="line">		validationErrs = &amp;types.MultiError&#123;&#125;</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">for</span> _, a := <span class="keyword">range</span> alerts &#123;</span><br><span class="line">		removeEmptyLabels(a.Labels)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := a.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			validationErrs.Add(err)</span><br><span class="line">			api.m.Invalid().Inc()</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		validAlerts = <span class="built_in">append</span>(validAlerts, a)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := api.alerts.Put(validAlerts...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		api.respondError(w, apiError&#123;</span><br><span class="line">			typ: errorInternal,</span><br><span class="line">			err: err,</span><br><span class="line">		&#125;, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> validationErrs.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">		api.respondError(w, apiError&#123;</span><br><span class="line">			typ: errorBadData,</span><br><span class="line">			err: validationErrs,</span><br><span class="line">		&#125;, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	api.respond(w, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到<code>60</code>行的<code>Put</code>方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Put 添加一到多个告警到告警集合里。并且通知到所有监听器里。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Alerts)</span> <span class="title">Put</span><span class="params">(alerts ...*types.Alert)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, alert := <span class="keyword">range</span> alerts &#123;</span><br><span class="line">		fp := alert.Fingerprint()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Check that there's an alert existing within the store before</span></span><br><span class="line">		<span class="comment">// trying to merge.</span></span><br><span class="line">		<span class="comment">// ---------------------------------------------------------------------</span></span><br><span class="line">		<span class="comment">// 检查是否已经有旧的告警了，如果有旧的告警，需要判断是否需要合并。</span></span><br><span class="line">		<span class="keyword">if</span> old, err := a.alerts.Get(fp); err == <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Merge alerts if there is an overlap in activity range.</span></span><br><span class="line">			<span class="comment">// -----------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// 合并条件：判断是否新旧告警有重叠时间，如果有的话，就进行合并告警。</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// 条件1：新告警的结束时间大于旧的告警的开始时间，并且新告警结束时间在旧告警结束时间之前。</span></span><br><span class="line">			<span class="comment">//        新告警   |----------|</span></span><br><span class="line">			<span class="comment">// 		  旧告警     |-----------|       -&gt; 时间线</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// 条件2：新告警的开始时间大于旧的告警的开始时间，并且新告警开始时间在旧告警结束时间之前。</span></span><br><span class="line">			<span class="comment">//		  新告警        |----------|</span></span><br><span class="line">			<span class="comment">//		  旧告警     |-----------|       -&gt; 时间线</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="keyword">if</span> (alert.EndsAt.After(old.StartsAt) &amp;&amp; alert.EndsAt.Before(old.EndsAt)) ||</span><br><span class="line">				(alert.StartsAt.After(old.StartsAt) &amp;&amp; alert.StartsAt.Before(old.EndsAt)) &#123;</span><br><span class="line">				alert = old.Merge(alert)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 设置告警到集合。</span></span><br><span class="line">		<span class="keyword">if</span> err := a.alerts.Set(alert); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			level.Error(a.logger).Log(<span class="string">"msg"</span>, <span class="string">"error on set alert"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 循环塞到每个监听器，去通知到每一个监听者。</span></span><br><span class="line">		a.mtx.Lock()</span><br><span class="line">		<span class="keyword">for</span> _, l := <span class="keyword">range</span> a.listeners &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> l.alerts &lt;- alert:</span><br><span class="line">			<span class="keyword">case</span> &lt;-l.done:</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		a.mtx.Unlock()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里就是接收告警，然后将其塞到每个监听器，然后去通知每一个监听者去处理，即Inhibitor和Dispatcher会处理接收到的每个告警</p>
<p>下面看下处理流程</p>
<h3 id="告警聚合处理流程"><a href="#告警聚合处理流程" class="headerlink" title="告警聚合处理流程"></a>告警聚合处理流程</h3><p>根据上面的分析，聚合初始化之后，最终调用的是<code>processAlert</code>方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理告警，得到相应分组，并对相应的分组插入这个告警。</span></span><br><span class="line"><span class="comment">// @param alert 告警结构体</span></span><br><span class="line"><span class="comment">// @param route 已经匹配上的分组路由</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dispatcher)</span> <span class="title">processAlert</span><span class="params">(alert *types.Alert, route *Route)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 根据分组路由的信息，获得此分组下的匹配中的labels。</span></span><br><span class="line">	<span class="comment">// 并根据所得labels得到唯一id(指纹 finger print)。</span></span><br><span class="line">	groupLabels := getGroupLabels(alert, route)</span><br><span class="line">	fp := groupLabels.Fingerprint()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 加锁进行hashmap操作</span></span><br><span class="line">	d.mtx.Lock()</span><br><span class="line">	<span class="keyword">defer</span> d.mtx.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通过分组路由获得分组map，如果分组列表hashmap不存在这个分组，</span></span><br><span class="line">	<span class="comment">// 则进行创建。分组map里面key为分组finger print，value为具</span></span><br><span class="line">	<span class="comment">// 体唯一标识的分组。</span></span><br><span class="line">	group, ok := d.aggrGroups[route]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		group = <span class="keyword">map</span>[model.Fingerprint]*aggrGroup&#123;&#125;</span><br><span class="line">		d.aggrGroups[route] = group</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the group does not exist, create it.</span></span><br><span class="line">	<span class="comment">// ----------------------------------------------------</span></span><br><span class="line">	<span class="comment">// 假如当前告警的group labels的指纹在这个告警分组map里找不到，</span></span><br><span class="line">	<span class="comment">// 则进行分组的创建。</span></span><br><span class="line">	ag, ok := group[fp]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		ag = newAggrGroup(d.ctx, groupLabels, route, d.timeout, d.logger)</span><br><span class="line">		group[fp] = ag</span><br><span class="line">		<span class="comment">// 普罗米修斯的分组数量指标进行加一</span></span><br><span class="line">		d.metrics.aggrGroups.Inc()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 开启新的协成，运行此告警指纹的分组</span></span><br><span class="line">		<span class="keyword">go</span> ag.run(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, alerts ...*types.Alert)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">			<span class="comment">// 根据当前context的状态，来进行告警的处理。</span></span><br><span class="line">			_, _, err := d.stage.Exec(ctx, d.logger, alerts...)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				lvl := level.Error(d.logger)</span><br><span class="line">				<span class="keyword">if</span> ctx.Err() == context.Canceled &#123;</span><br><span class="line">					<span class="comment">// It is expected for the context to be canceled on</span></span><br><span class="line">					<span class="comment">// configuration reload or shutdown. In this case, the</span></span><br><span class="line">					<span class="comment">// message should only be logged at the debug level.</span></span><br><span class="line">					<span class="comment">// ---------------------------------------------------</span></span><br><span class="line">					<span class="comment">// 假如错误是因为reload或者关闭而导致的，那样日志等级为debug</span></span><br><span class="line">					lvl = level.Debug(d.logger)</span><br><span class="line">				&#125;</span><br><span class="line">				lvl.Log(<span class="string">"msg"</span>, <span class="string">"Notify for alerts failed"</span>, <span class="string">"num_alerts"</span>, <span class="built_in">len</span>(alerts), <span class="string">"err"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> err == <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 插入alert到这个唯一标识的分组里。</span></span><br><span class="line">	ag.insert(alert)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第35行是进行告警发送的流程，最终执行的是Exec方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stage 在所给予的上下文限制中处理所有告警。</span></span><br><span class="line"><span class="keyword">type</span> Stage <span class="keyword">interface</span> &#123;</span><br><span class="line">	Exec(ctx context.Context, l log.Logger, alerts ...*types.Alert) (context.Context, []*types.Alert, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createReceiverStage 为一个接口人创建一个扇出的阶段管道。这里循环这个接受方式的</span></span><br><span class="line"><span class="comment">// 每一个接收人，然后为每个接收人创建一个MultiStage，用来装载多个阶段。每个Multistage</span></span><br><span class="line"><span class="comment">// 包含一个等待阶段，去重阶段，重试阶段和设置通知信息阶段。最后把每个MultiStage都添加</span></span><br><span class="line"><span class="comment">// 到扇出阶段，并进行返回。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createReceiverStage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	name <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	integrations []Integration,</span></span></span><br><span class="line"><span class="function"><span class="params">	wait <span class="keyword">func</span>()</span> <span class="title">time</span>.<span class="title">Duration</span>,</span></span><br><span class="line"><span class="function">	<span class="title">notificationLog</span> <span class="title">NotificationLog</span>,</span></span><br><span class="line"><span class="function">	<span class="title">metrics</span> *<span class="title">metrics</span>,</span></span><br><span class="line"><span class="function">) <span class="title">Stage</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> fs FanoutStage</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> integrations &#123;</span><br><span class="line">		recv := &amp;nflogpb.Receiver&#123;</span><br><span class="line">			GroupName:   name,</span><br><span class="line">			Integration: integrations[i].Name(),</span><br><span class="line">			Idx:         <span class="keyword">uint32</span>(integrations[i].Index()),</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> s MultiStage</span><br><span class="line">		<span class="comment">// 等待阶段</span></span><br><span class="line">		s = <span class="built_in">append</span>(s, NewWaitStage(wait))</span><br><span class="line">		<span class="comment">// 去重阶段</span></span><br><span class="line">		s = <span class="built_in">append</span>(s, NewDedupStage(&amp;integrations[i], notificationLog, recv))</span><br><span class="line">		<span class="comment">// 重试阶段</span></span><br><span class="line">		s = <span class="built_in">append</span>(s, NewRetryStage(integrations[i], name, metrics))</span><br><span class="line">		<span class="comment">// 设置通知信息阶段</span></span><br><span class="line">		s = <span class="built_in">append</span>(s, NewSetNotifiesStage(notificationLog, recv))</span><br><span class="line"></span><br><span class="line">		fs = <span class="built_in">append</span>(fs, s)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在进行发送的时候依次进行，等待阶段、去重阶段、重试阶段、设置通知信息阶段，即分别是以下方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewWaitStage 返回一个新的等待阶段。设置wait方法到阶段之中。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWaitStage</span><span class="params">(wait <span class="keyword">func</span>()</span> <span class="title">time</span>.<span class="title">Duration</span>) *<span class="title">WaitStage</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;WaitStage&#123;</span><br><span class="line">		wait: wait,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exec implements the Stage interface.</span></span><br><span class="line"><span class="comment">// ------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Exec 实现了 Stage 接口，等待特定的一段时间，或者ctx.Done。取决于哪个事件先完成。</span></span><br><span class="line"><span class="comment">// 如果ctx.Done 先发生，则返回上下文里的错误。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *WaitStage)</span> <span class="title">Exec</span><span class="params">(ctx context.Context, l log.Logger, alerts ...*types.Alert)</span> <span class="params">(context.Context, []*types.Alert, error)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewDedupStage 包裹一个 DedupStage， 这个。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDedupStage</span><span class="params">(rs ResolvedSender, l NotificationLog, recv *nflogpb.Receiver)</span> *<span class="title">DedupStage</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;DedupStage&#123;</span><br><span class="line">		rs:    rs,</span><br><span class="line">		nflog: l,</span><br><span class="line">		recv:  recv,</span><br><span class="line">		now:   utcNow,</span><br><span class="line">		hash:  hashAlert,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exec 实现了 Stage 接口，将进行告警的去重，并获取消息日志，查看是否需要更新日志状态。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *DedupStage)</span> <span class="title">Exec</span><span class="params">(ctx context.Context, l log.Logger, alerts ...*types.Alert)</span> <span class="params">(context.Context, []*types.Alert, error)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...其余的方法可自行查看</span><br></pre></td></tr></table></figure>
<h4 id="WaitStage"><a href="#WaitStage" class="headerlink" title="WaitStage"></a>WaitStage</h4><p>等待间隔用来设置发送告警的等待时间，对于集群操作中，需要根据不同的peer设置不同的超时时间，如果仅仅一个Server本身，等待间隔设置为0；</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clusterWait returns a function that inspects the current peer state and returns</span></span><br><span class="line"><span class="comment">// a duration of one base timeout for each peer with a higher ID than ourselves.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clusterWait</span><span class="params">(p *cluster.Peer, timeout time.Duration)</span> <span class="title">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Duration</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Duration</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> time.Duration(p.Position()) * timeout</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>具体的实现上采用一个timer来传递信号，一旦时间到达后才返回对应的alerts，由于是串行执行的，所以消息传递会中止一段时间。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Exec implements the Stage interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *WaitStage)</span> <span class="title">Exec</span><span class="params">(ctx context.Context, l log.Logger, alerts ...*types.Alert)</span> <span class="params">(context.Context, []*types.Alert, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(ws.wait()):</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, ctx.Err()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ctx, alerts, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="DedupStage"><a href="#DedupStage" class="headerlink" title="DedupStage"></a>DedupStage</h4><p>DedupStage用于管理告警的去重，传递的参数中包含了一个NotificationLog,用来保存告警的发送记录。当有多个机器组成集群的时候，NotificationLog会通过协议去进行通信，传递彼此的记录信息，加入集群中的A如果发送了告警，该记录会传递给B机器，并进行merge操作，这样B机器在发送告警的时候如果查询已经发送，则不再进行告警发送。关于NotificationLog的实现nflog可以查看nflog/nflog.go文件。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DedupStage filters alerts.</span></span><br><span class="line"><span class="comment">// Filtering happens based on a notification log.</span></span><br><span class="line"><span class="keyword">type</span> DedupStage <span class="keyword">struct</span> &#123;</span><br><span class="line">    nflog NotificationLog</span><br><span class="line">    recv  *nflogpb.Receiver</span><br><span class="line">    conf  notifierConfig</span><br><span class="line"></span><br><span class="line">    now  <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span></span><br><span class="line"><span class="function">    <span class="title">hash</span> <span class="title">func</span><span class="params">(*types.Alert)</span> <span class="title">uint64</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>具体的处理逻辑如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *DedupStage)</span> <span class="title">Exec</span><span class="params">(ctx context.Context, l log.Logger, alerts ...*types.Alert)</span> <span class="params">(context.Context, []*types.Alert, error)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    entries, err := n.nflog.Query(nflog.QGroupKey(gkey), nflog.QReceiver(n.recv))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != nflog.ErrNotFound &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> entry *nflogpb.Entry</span><br><span class="line">    <span class="keyword">switch</span> <span class="built_in">len</span>(entries) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        entry = entries[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unexpected entry result size %d"</span>, <span class="built_in">len</span>(entries))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n.needsUpdate(entry, firingSet, resolvedSet, repeatInterval) &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx, alerts, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">		<span class="keyword">return</span> ctx, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的nflog.Query将根据接收和group key进行查询，一旦查找到，则不再返回对应的alerts. nflog设置了GC用来删除过期的日志记录。防止一直存在log中导致告警无法继续发送.</p>
<h4 id="RetryStage"><a href="#RetryStage" class="headerlink" title="RetryStage"></a>RetryStage</h4><p>RetryStage利用backoff策略来管理告警的重发，对于没有发送成功的告警将不断重试，直到超时时间,numFailedNotifications用来传递发送失败的统计metrics,numNotifications用来发送成功的metrics统计信息。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-tick.C:</span><br><span class="line">        now := time.Now()</span><br><span class="line">        retry, err := r.integration.Notify(ctx, sent...)</span><br><span class="line">        notificationLatencySeconds.WithLabelValues(r.integration.name).Observe(time.Since(now).Seconds())</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            numFailedNotifications.WithLabelValues(r.integration.name).Inc()</span><br><span class="line">            level.Debug(l).Log(<span class="string">"msg"</span>, <span class="string">"Notify attempt failed"</span>, <span class="string">"attempt"</span>, i, <span class="string">"integration"</span>, r.integration.name, <span class="string">"receiver"</span>, r.groupName, <span class="string">"err"</span>, err)</span><br><span class="line">            <span class="keyword">if</span> !retry &#123;</span><br><span class="line">                <span class="keyword">return</span> ctx, alerts, fmt.Errorf(<span class="string">"cancelling notify retry for %q due to unrecoverable error: %s"</span>, r.integration.name, err)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Save this error to be able to return the last seen error by an</span></span><br><span class="line">            <span class="comment">// integration upon context timeout.</span></span><br><span class="line">            iErr = err</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            numNotifications.WithLabelValues(r.integration.name).Inc()</span><br><span class="line">            <span class="keyword">return</span> ctx, alerts, <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="keyword">if</span> iErr != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx, <span class="literal">nil</span>, iErr</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, ctx.Err()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="SetNotifiesStage"><a href="#SetNotifiesStage" class="headerlink" title="SetNotifiesStage"></a>SetNotifiesStage</h4><p>SetNotifiesStage用来设置发送告警的信息到nfLog，该模块仅仅用于被该AM发送的告警的记录（Retry组件传递的alerts和Dedup组件中发送出去的告警信息）。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Exec implements the Stage interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n SetNotifiesStage)</span> <span class="title">Exec</span><span class="params">(ctx context.Context, l log.Logger, alerts ...*types.Alert)</span> <span class="params">(context.Context, []*types.Alert, error)</span></span> &#123;</span><br><span class="line">    gkey, ok := GroupKey(ctx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"group key missing"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    firing, ok := FiringAlerts(ctx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"firing alerts missing"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resolved, ok := ResolvedAlerts(ctx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"resolved alerts missing"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ctx, alerts, n.nflog.Log(n.recv, gkey, firing, resolved)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="告警抑制处理流程"><a href="#告警抑制处理流程" class="headerlink" title="告警抑制处理流程"></a>告警抑制处理流程</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行抑制器，会开始订阅告警。然后开始循环，如果订阅的告警遍历器里面有告警，</span></span><br><span class="line"><span class="comment">// 则获得告警，并循环每个抑制规则，如果匹配到</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ih *Inhibitor)</span> <span class="title">run</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 开始订阅告警</span></span><br><span class="line">	it := ih.alerts.Subscribe()</span><br><span class="line">	<span class="keyword">defer</span> it.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> a := &lt;-it.Next():</span><br><span class="line">			<span class="comment">// 得到告警，</span></span><br><span class="line">			<span class="keyword">if</span> err := it.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				level.Error(ih.logger).Log(<span class="string">"msg"</span>, <span class="string">"Error iterating alerts"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Update the inhibition rules' cache.</span></span><br><span class="line">			<span class="comment">// -----------------------------------------</span></span><br><span class="line">			<span class="comment">// 循环每个抑制rule，假如当前告警匹配上某个source。</span></span><br><span class="line">			<span class="comment">// 缓存这个告警到这个抑制rule的告警map里，map的key</span></span><br><span class="line">			<span class="comment">// 为label的finger print，value为alert。</span></span><br><span class="line">			<span class="keyword">for</span> _, r := <span class="keyword">range</span> ih.rules &#123;</span><br><span class="line">				<span class="keyword">if</span> r.SourceMatchers.Match(a.Labels) &#123;</span><br><span class="line">					<span class="keyword">if</span> err := r.scache.Set(a); err != <span class="literal">nil</span> &#123;</span><br><span class="line">						level.Error(ih.logger).Log(<span class="string">"msg"</span>, <span class="string">"error on set alert"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>链接：</p>
<p><a href="https://www.jianshu.com/p/239b145e2acc" target="_blank" rel="external">Prometheus Alertmanager报警组件</a></p>
<p><a href="https://just4fun.im/2018/05/25/study_alertmanager/" target="_blank" rel="external">https://just4fun.im/2018/05/25/study_alertmanager/</a></p>
<p><a href="https://github.com/annotated-golang/alertmanager-with-comment" target="_blank" rel="external">alertmanager-with-comment</a></p>
<p><a href="https://blog.csdn.net/u014029783/article/details/80663092?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-3.baidujs&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-3.baidujs" target="_blank" rel="external">Prometheus AlertManager代码阅读笔记 Notify组件</a></p>
<p><a href="https://blog.csdn.net/jianyuanPC/article/details/52756887?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.baidujs&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.baidujs" target="_blank" rel="external">Prometheus源码分析(二)配置文件说明</a></p>
<p><a href="https://www.modb.pro/db/103988" target="_blank" rel="external">Prometheus系列5 - Alertmanager源码阅读</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

<blockquote class="blockquote-center" style="color: #ccc;">
    -------------本文结束 <i class="fa fa-apple"></i> 感谢您的阅读-------------
</blockquote>

  <span id="inline-green" style="border-radius:3px;">作者</span>：<a class="link-blue" href="https://github.com/magiceses" target="_blank">Magiceses</a><br/>有问题请 <a class="link-blue" href="https://magiceses.github.io/guestbook" target="_blank">留言</a> 或者私信我的 <a class="link-blue" href="https://weibo.com/u/3069595351" target="_blank">微博</a>。

  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>满分是10分的话，这篇文章你给几分</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/reward/reward_wechat.png" alt="magiceses WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/reward/reward_alipay.png" alt="magiceses Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Prometheus/" rel="tag"><i class="fa fa-tag"></i> Prometheus</a>
          
            <a href="/tags/Alertmanager/" rel="tag"><i class="fa fa-tag"></i> Alertmanager</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/13/python-进程线程协程-5/" rel="next" title="Python 进程线程协程(4)--线程池">
                <i class="fa fa-chevron-left"></i> Python 进程线程协程(4)--线程池
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/10/python-web-pecan框架使用及源码分析/" rel="prev" title="Pecan 框架使用及源码分析">
                Pecan 框架使用及源码分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/avatar/avatar.png"
               alt="magiceses" />
          <p class="site-author-name" itemprop="name">magiceses</p>
          <p class="site-description motion-element" itemprop="description">Stay Hungry,Stay Foolish</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">36</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/magiceses" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://blog.csdn.net/weixin_43700106" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-chrome"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="/weblog" title="建站日志" target="_blank">建站日志</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="/reward" title="打赏" target="_blank">打赏</a>
                </li>
              
            </ul>
          </div>
        
      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概述"><span class="nav-number">1.</span> <span class="nav-text">基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现架构"><span class="nav-number">2.</span> <span class="nav-text">实现架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件"><span class="nav-number">3.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#alertmanager"><span class="nav-number">3.1.</span> <span class="nav-text">alertmanager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prometheus"><span class="nav-number">3.2.</span> <span class="nav-text">prometheus</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#功能介绍"><span class="nav-number">4.</span> <span class="nav-text">功能介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#告警路由"><span class="nav-number">4.1.</span> <span class="nav-text">告警路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警聚合"><span class="nav-number">4.2.</span> <span class="nav-text">告警聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警抑制"><span class="nav-number">4.3.</span> <span class="nav-text">告警抑制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警屏蔽"><span class="nav-number">4.4.</span> <span class="nav-text">告警屏蔽</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警发送"><span class="nav-number">4.5.</span> <span class="nav-text">告警发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#报警规则"><span class="nav-number">4.6.</span> <span class="nav-text">报警规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码解析"><span class="nav-number">5.</span> <span class="nav-text">源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务启动"><span class="nav-number">5.1.</span> <span class="nav-text">服务启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警聚合初始化"><span class="nav-number">5.2.</span> <span class="nav-text">告警聚合初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警抑制初始化"><span class="nav-number">5.3.</span> <span class="nav-text">告警抑制初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">5.4.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警聚合处理流程"><span class="nav-number">5.5.</span> <span class="nav-text">告警聚合处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WaitStage"><span class="nav-number">5.5.1.</span> <span class="nav-text">WaitStage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DedupStage"><span class="nav-number">5.5.2.</span> <span class="nav-text">DedupStage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RetryStage"><span class="nav-number">5.5.3.</span> <span class="nav-text">RetryStage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SetNotifiesStage"><span class="nav-number">5.5.4.</span> <span class="nav-text">SetNotifiesStage</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警抑制处理流程"><span class="nav-number">5.6.</span> <span class="nav-text">告警抑制处理流程</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

      
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        

<div class="busuanzi-count">

  <!-- <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- 上面这个是之前的，不知道为什么失效了，改成下面这个 -->
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">您是第<span class="busuanzi-value" id="busuanzi_value_site_uv"></span>个小伙伴</span>
  

  
    <span class="site-pv">本站总浏览<span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">magiceses</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Pisces
  </a>
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count" style="color: #e90f92;">全站共 724k 字</span>
</div>
        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


  <!-- 按需加载背景 -->
  <!-- 背景动画 -->
<script type="text/javascript">
  // 按需加载背景
  // 如果是all，就直接加载了
  if("pc" == "all") {
    $.getScript("/js/src/particle.js?v=5.0.1");
  }
  // 识别手机或电脑的js开始
  (function(){
    var res = GetRequest();
    var par = res['index'];
    if(par!='gfan'){
      var ua=navigator.userAgent.toLowerCase();
      var contains=function (a, b){
          if(a.indexOf(b)!=-1){return true;}
      };
      if((contains(ua,"android") && contains(ua,"mobile"))||(contains(ua,"android") && contains(ua,"mozilla"))||(contains(ua,"android") && contains(ua,"opera"))||contains(ua,"ucweb7")||contains(ua,"iphone")){
        return false;
      } else {
        $.getScript("/js/src/particle.js?v=5.0.1");
      }
    }
  })();
  function GetRequest() {
    var url = location.search;
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
      var str = url.substr(1);
      strs = str.split("&");
      for(var i = 0; i < strs.length; i ++) {
        theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
      }
    }
    return theRequest;
  }
</script>
<!-- 识别手机或电脑的js结束 -->  

  <!-- 页面点击小红心 -->
  <!-- 页面点击小红心 -->

  <script type="text/javascript" src="/js/src/love.js?v=5.0.1"></script>


  <!-- 鼠标移动，效果 -->
  <!-- 鼠标移动特效 -->

  <script type="text/javascript" src="/js/src/jquery-stars.js?v=5.0.1"></script>
  <script type="text/javascript">
  jQuery('body').jstars({
  	image_path: '/images',
  	image: 'candy-cane-stars.png',
  	style: 'white',
  	width: 34,
  	height: 34,
  	delay: 700,
  	frequency: 5
  });
  </script>


  <!-- 页面 title 进入/离开 效果 -->

  <script type="text/javascript">var OriginTitile=document.title,st;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="Waiting for you back！",clearTimeout(st)):(document.title="Thanks for visit~ "+OriginTitile,st=setTimeout(function(){document.title=OriginTitile},4e3))})</script>


</body>
</html>
